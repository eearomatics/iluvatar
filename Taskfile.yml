version: '3'

tasks:
  init:
    cmds:
      - task: ee:clean
      - task: ee:init
      - task: tr:clean
      - task: tr:init

  tf:init:
    desc: Common tf initialization task.
    preconditions: &necessary-tf-envs
      # - sh: 'test -d "{{.TF_PROJECT_DIR}}"'
      #   msg: "Missing Terraform project directory var"
      - sh: 'test -n "$TF_VAR_r2_api_token"'
        msg: "Missing TF_VAR_r2_api_token in your environment"
      - sh: 'test -n "$AWS_REGION"'
        msg: "Missing AWS_REGION in your environment"
      - sh: 'test -n "$AWS_ACCESS_KEY_ID"'
        msg: "Missing AWS_ACCESS_KEY_ID in your environment"
      - sh: 'test -n "$AWS_SECRET_ACCESS_KEY"'
        msg: "Missing AWS_SECRET_ACCESS_KEY in your environment"
      - sh: 'test -n "$AWS_ENDPOINT_URL_S3"'
        msg: "Missing AWS_ENDPOINT_URL_S3 in your environment"
    requires:
      vars: [TF_PROJECT_DIR]
    dir: '{{.TF_PROJECT_DIR}}'
    cmds:
      - tofu init -backend-config=../backends/cloudflare-r2.conf
  tf:plan:
    desc: Common tf plan task.
    dir: '{{.TF_PROJECT_DIR}}'
    preconditions: *necessary-tf-envs
    cmds:
      - tofu plan
  tf:apply:
    desc: Common tf apply task.
    dir: '{{.TF_PROJECT_DIR}}'
    preconditions: *necessary-tf-envs
    cmds:
      - tofu apply {{.CLI_ARGS}}
  tf:clean:
    desc: Common tf project cleaning task.
    dir: '{{.TF_PROJECT_DIR}}'
    preconditions: *necessary-tf-envs
    cmds:
      - rm -rf ./.terraform .terraform.lock.hcl
  tf:run:
    desc: Common tf project runner task.
    dir: '{{.TF_PROJECT_DIR}}'
    preconditions: *necessary-tf-envs
    cmds:
      - tofu {{.CLI_ARGS}}

  ee:init:
    desc: Initialize the eearomatics.com Terraform module
    cmds:
      - task: tf:init
        vars:
          TF_PROJECT_DIR: infrastructure/eearomatics
  ee:plan:
    desc: Plan the eearomatics.com Terraform module
    cmds:
      - task: tf:plan
        vars:
          TF_PROJECT_DIR: infrastructure/eearomatics
  ee:apply:
    desc: Apply the eearomatics.com Terraform module
    cmds:
      - task: tf:apply
        vars:
          TF_PROJECT_DIR: infrastructure/eearomatics
  ee:clean:
    desc: Clean the eearomatics.com Terraform module
    cmds:
      - task: tf:clean
        vars:
          TF_PROJECT_DIR: infrastructure/eearomatics
  ee:run:
    desc: Run a command in the eearomatics.com Terraform module
    cmds:
      - task: tf:run
        vars:
          TF_PROJECT_DIR: infrastructure/eearomatics

  tr:init:
    desc: Initialize the torinreine.com Terraform module
    cmds:
      - task: tf:init
        vars:
          TF_PROJECT_DIR: infrastructure/torinreine
  tr:plan:
    desc: Plan the torinreine.com Terraform module
    cmds:
      - task: tf:plan
        vars:
          TF_PROJECT_DIR: infrastructure/torinreine
  tr:apply:
    desc: Apply the torinreine.com Terraform module
    cmds:
      - task: tf:apply
        vars:
          TF_PROJECT_DIR: infrastructure/torinreine
  tr:clean:
    desc: Clean the torinreine.com Terraform module
    cmds:
      - task: tf:clean
        vars:
          TF_PROJECT_DIR: infrastructure/torinreine
  tr:run:
    desc: Run a command in the torinreine.com Terraform module
    cmds:
      - task: tf:run
        vars:
          TF_PROJECT_DIR: infrastructure/torinreine
